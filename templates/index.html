<!--
  Hauptseite fÃ¼r die Partyâ€‘Wunschliste.
  GÃ¤ste kÃ¶nnen Songs hinzufÃ¼gen und liken.  Wenn der DJ eingeloggt ist,
  erscheinen zusÃ¤tzliche SchaltflÃ¤chen zum Entfernen von Songs.
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Partyâ€‘Wunschliste</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="brand">
            <h1>Partyâ€‘MusikwÃ¼nsche</h1>
            <p class="tagline">Schnell auf dem Smartphone checken und voten</p>
        </div>
        <nav>
            {% if dj_logged_in %}
                <form method="post" action="{{ url_for('logout') }}" style="display:inline;">
                    <button type="submit">DJ abmelden</button>
                </form>
            {% else %}
                <a class="ghost" href="{{ url_for('login') }}">DJâ€‘Login</a>
            {% endif %}
        </nav>
    </header>

    <main class="page">
        <!-- Flashâ€‘Nachrichten anzeigen -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
              {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <section id="add-song">
            <h2>Neuen Song hinzufÃ¼gen</h2>
            <form method="post" action="{{ url_for('add_song') }}" id="add-song-form">
                <label for="title">Songtitel</label>
                <input type="text" id="title" name="title" placeholder="z. B. Levitating" required>
                <label for="artist">KÃ¼nstler</label>
                <input type="text" id="artist" name="artist" placeholder="z. B. Dua Lipa" required>
                <button type="submit" class="primary">Song speichern</button>
            </form>
        </section>

        <section id="song-list">
            <div class="section-head">
                <h2>Warteschlange</h2>
                <p class="muted">Tippen statt scrollen â€“ perfekt fÃ¼rs Handy.</p>
            </div>
            <ul id="songs-container">
                {# The list will be populated dynamically by JavaScript #}
                {% if not songs %}
                    <li class="song-card"><p>Die Warteschlange ist leer. FÃ¼ge den ersten Song hinzu!</p></li>
                {% endif %}
            </ul>
        </section>

        <section id="genre-vote" class="muted-block">
            <h2>Genreâ€‘Abstimmung</h2>
            <blockquote class="notice">Die Genreâ€‘Abstimmung ruht gerade und ist nur als Referenz hinterlegt.</blockquote>
            <!--
            <form method="post" action="{{ url_for('vote_genre') }}" id="genre-form">
                <label for="genre">WÃ¤hle ein Genre:</label>
                <select name="genre" id="genre" required>
                    {% for genre in genres %}
                        <option value="{{ genre }}" {% if voted_genre == genre %}selected{% endif %}>{{ genre }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Abstimmen</button>
            </form>
            <div id="genre-results">
                {% if total_votes > 0 %}
                    {% for item in genre_data %}
                        <div class="genre-result {% if item.genre == top_genre %}top-genre{% endif %}">
                            <span class="genre-name">{{ item.genre }}</span>
                            <div class="bar-container"><div class="bar" style="width: {{ item.percentage }}%;"></div></div>
                            <span class="percentage">{{ '%.0f'|format(item.percentage) }}%</span>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Noch keine Stimmen.</p>
                {% endif %}
            </div>
            -->
        </section>

        {% if dj_logged_in %}
        <section id="dj-area">
            <h2>DJâ€‘Bereich</h2>
            <p>Insgesamt {{ songs|length }} Songs in der Warteschlange.</p>
            <div class="dj-table-container">
            <table class="dj-table">
                <thead>
                    <tr>
                        <th>Titel</th>
                        <th>KÃ¼nstler</th>
                        <th>Likes</th>
                        <th>Dislikes</th>
                        <th>Zeit</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    {% for song in songs %}
                    <tr>
                        <td data-label="Titel">{{ song.title }}</td>
                        <td data-label="KÃ¼nstler">{{ song.artist }}</td>
                        <td data-label="Likes">{{ song.likes }}</td>
                        <td data-label="Dislikes">{{ song.dislikes or 0 }}</td>
                        <td data-label="Zeit">{{ song.timestamp }}</td>
                        <td data-label="Aktion">
                            <form method="post" action="{{ url_for('remove_song', song_id=song.id) }}" class="remove-form">
                                <button type="submit">Entfernen</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </section>
        {% endif %}

        <footer>
            <p>Freie Software â€“ Viel SpaÃŸ beim Feiern!</p>
        </footer>
    </main>

    <!-- Dynamisches Aktualisieren ohne Seiten-Reload.  Dieses Skript ruft regelmÃ¤ÃŸig
         Daten von /data ab und aktualisiert die Warteschlange sowie das
         Genreâ€‘Abstimmungsâ€‘Ergebnis.  Formulare fÃ¼r Likes, Entfernen und Genreâ€‘Vote
         werden per Fetch gesendet, sodass der Nutzer auf mobilen GerÃ¤ten nicht
         aus dem Fluss gerissen wird. -->
    <script>
      const likedSongs = {{ liked_songs | tojson | safe }};
      const dislikedSongs = {{ disliked_songs | tojson | safe }};
      const djLoggedIn = {{ dj_logged_in | tojson | safe }};
      document.addEventListener('DOMContentLoaded', function() {
        function fetchData() {
          fetch('{{ url_for('data') }}')
            .then(response => response.json())
            .then(data => {
              updateSongs(data.songs);
            });
        }
        function updateSongs(songs) {
          const container = document.getElementById('songs-container');
          if (!container) return;
          // If there are no songs, show placeholder message
          if (songs.length === 0) {
            container.innerHTML = '<li class="song-card"><p>Die Warteschlange ist leer. FÃ¼ge den ersten Song hinzu!</p></li>';
            return;
          }
          container.innerHTML = '';
          songs.forEach(song => {
            const li = document.createElement('li');
            li.className = 'song-card';
            // Info Block
            const info = document.createElement('div');
            info.className = 'song-info';
            info.innerHTML = '<span class="song-title">' + song.title + '</span><span class="song-artist">von ' + song.artist + '</span>';
            li.appendChild(info);
            // Actions Block
            const actions = document.createElement('div');
            actions.className = 'song-actions';
            // Like form
            const likeForm = document.createElement('form');
            likeForm.method = 'post';
            likeForm.action = '/like/' + song.id;
            likeForm.className = 'like-form inline-form';
            const likeBtn = document.createElement('button');
            likeBtn.type = 'submit';
            likeBtn.className = 'thumb-btn like-btn';
            // Set button text and class based on whether this song is already liked
            if (likedSongs.includes(song.id)) {
              likeBtn.textContent = 'ðŸ‘ ' + song.likes;
              likeBtn.classList.add('active');
            } else {
              likeBtn.textContent = 'ðŸ‘ ' + song.likes;
            }
            likeForm.appendChild(likeBtn);
            actions.appendChild(likeForm);
            // Dislike form
            const dislikeForm = document.createElement('form');
            dislikeForm.method = 'post';
            dislikeForm.action = '/dislike/' + song.id;
            dislikeForm.className = 'dislike-form inline-form';
            const dislikeBtn = document.createElement('button');
            dislikeBtn.type = 'submit';
            dislikeBtn.className = 'thumb-btn dislike-btn';
            if (dislikedSongs.includes(song.id)) {
              dislikeBtn.textContent = 'ðŸ‘Ž ' + song.dislikes;
              dislikeBtn.classList.add('active');
            } else {
              dislikeBtn.textContent = 'ðŸ‘Ž ' + song.dislikes;
            }
            dislikeForm.appendChild(dislikeBtn);
            actions.appendChild(dislikeForm);
            // Remove form if DJ
            if (djLoggedIn) {
              const removeForm = document.createElement('form');
              removeForm.method = 'post';
              removeForm.action = '/remove/' + song.id;
              removeForm.className = 'remove-form inline-form';
              const removeBtn = document.createElement('button');
              removeBtn.type = 'submit';
              removeBtn.textContent = 'Entfernen';
              removeForm.appendChild(removeBtn);
              actions.appendChild(removeForm);
            }
            li.appendChild(actions);
            container.appendChild(li);
          });
        }
        // Submit handlers for like, dislike and remove forms
        document.addEventListener('submit', function(e) {
          const form = e.target;
          if (form.classList.contains('like-form') || form.classList.contains('dislike-form') || form.classList.contains('remove-form')) {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(form.action, {
              method: form.method,
              body: formData
            }).then(() => {
              const likeMatch = form.action.match(/\/like\/(\d+)/);
              const dislikeMatch = form.action.match(/\/dislike\/(\d+)/);
              const id = likeMatch ? parseInt(likeMatch[1], 10) : dislikeMatch ? parseInt(dislikeMatch[1], 10) : null;
              if (id !== null) {
                if (form.classList.contains('like-form')) {
                  const likedIndex = likedSongs.indexOf(id);
                  if (likedIndex !== -1) {
                    likedSongs.splice(likedIndex, 1);
                  } else {
                    likedSongs.push(id);
                    const dislikedIndex = dislikedSongs.indexOf(id);
                    if (dislikedIndex !== -1) {
                      dislikedSongs.splice(dislikedIndex, 1);
                    }
                  }
                }
                if (form.classList.contains('dislike-form')) {
                  const dislikedIndex = dislikedSongs.indexOf(id);
                  if (dislikedIndex !== -1) {
                    dislikedSongs.splice(dislikedIndex, 1);
                  } else {
                    dislikedSongs.push(id);
                    const likedIndex = likedSongs.indexOf(id);
                    if (likedIndex !== -1) {
                      likedSongs.splice(likedIndex, 1);
                    }
                  }
                }
              }
              fetchData();
            });
          }
        });
        // Initial fetch and periodic polling
        fetchData();
        setInterval(fetchData, 5000);
      });
    </script>
</body>
</html>
